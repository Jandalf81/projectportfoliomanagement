<!DOCTYPE html>
<?php
	$ini = parse_ini_file('ppm.ini');
	//print "dbFile: {$ini['dbFile']}";
	
	include '_functions.php';
	
// TODO: nicht als Tabelle, sondern als DIV darstellen, bringt mehr Layout-Möglichkeiten
	$db = new SQLite3("{$ini['dbFile']}");
	
	$ddPriorität = new DropDownOptions($db, 'SELECT * FROM t_list_priorität ORDER BY id DESC');
	$ddKomplexität = new DropDownOptions($db, 'SELECT * FROM t_list_komplexität ORDER BY id DESC');
	$ddStatus = new DropDownOptions($db, 'SELECT * FROM t_list_status ORDER BY id ASC');
?>
<html>
	<head>
		<link rel="stylesheet" href="ppm.css">
		
		<script type="text/javascript">
			function updatePerson2Projekt (projektID, rolleID) {
				var form = document.createElement("form");
				form.method = "POST";
				form.action = "updatePerson2Projekt.html";
				form.target = "newWindow";
				
				var input_id = document.createElement("input");
				input_id.id = "projektID";
				input_id.name = "projektID";
				input_id.type = "hidden";
				input_id.value = projektID;
				form.appendChild(input_id);
				
				var input_rolle = document.createElement("input");
				input_rolle.id = "rolleID";
				input_rolle.name = "rolleID";
				input_rolle.type = "hidden";
				input_rolle.value = rolleID;
				form.appendChild(input_rolle);
				
				document.body.appendChild(form);
				
				window.open('', 'newWindow', 'location=yes,width=600,height=800');
				form.submit();
			}
		</script>
	</head>
	<body>
		<details>
			<summary><img src="./icons/add.png" /> Neues Projekt anlegen</summary>
			<table>
				<tr>
					<th>Vorgänger</th>
					<th>Name</th>
					<th>Startdatum</th>
					<th>Enddatum</th>
					<th>Priorität</th>
					<th>Komplexität</th>
					<th>Status</th>
					<th>Fortschritt</th>
					<th>ANLEGEN</th>
				</tr>
				<tr>
					<form action="updateProjekt.html" method="POST" target="POPUPW" onsubmit="POPUPW = window.open('about:blank', 'POPUPW', 'width=600,height=400');">
						<td><input type="hidden" name="todo" value="insert"><input type="text" name="vorgänger"></td>
						<td><input type="text" name="name" required></td>
						<td><input type="date" name="startdatum"></td>
						<td><input type="date" name="enddatum"></td>
						<td><select name='fk_priorität' 'size='1' required>
							<option value="" disabled selected>bitte auswählen</option>
							<?php $ddPriorität->listOptions() ?>
						</select></td>
						<td><select name='fk_komplexität' 'size='1' required>
							<option value="" disabled selected>bitte auswählen</option>
							<?php $ddKomplexität->listOptions() ?>
						</select></td>
						<td><select name='fk_status' 'size='1' required>
							<option value="" disabled selected>bitte auswählen</option>
							<?php $ddStatus->listOptions() ?>
						</select></td>
						<td><input type='number' name='fortschritt' min='0' max='100' value="0"></td>
						<td><input type='submit' name='save' value='anlegen' /></td>
					</form>
				</tr>
			</table>
		</details>
		
		
		<h2>Bestehende Projekte aktualisieren</h2>
		<table>
			<tr>
				<th>ID</th>
				<th>Vorgänger</th>
				<th>Name</th>
				<th>Auftraggeber</th>
				<th>Startdatum</th>
				<th>Enddatum</th>
<!--				<th>Projektleiter</th>       -->
<!--				<th>Mitglieder</th>          -->
				<th>Priorität</th>
				<th>Komplexität</th>
				<th>Status</th>
				<th>Fortschritt</th>
				<th>UPDATE</th>
			</tr>

<?php
// TODO: Inhalte der Dropdown-Listen als Arrays speichern und wiederverwenden -> DONE
// TODO: Laden der Listen in Funktion auslagern und wiederverwendbar machen -> DONE
	
	$res = $db->query('SELECT * FROM t_data_projekt ORDER BY id');
	while ($row = $res->fetchArray()) {
		print "<tr><form action='updateProjekt.html' method='POST' target='POPUPW' onsubmit='POPUPW = window.open(\"about:blank\", \"POPUPW\", \"width=600,height=400\");'>\n";
		
		print "<td><input type='hidden' name='todo' value='update'><input type='text' name='id' value='{$row['id']}' readonly></td>\n";
		
		print "<td><input type='text' name='vorgänger' value='{$row['vorgänger']}'>  <img src='icons/chart_line_edit.png' /></td>\n";
		print "<td><input type='text' name='name' value='{$row['name']}'></td>\n";
		print "<td><input type='text' name='auftraggeber' readonly> <img src='icons/user_edit.png' onclick='updatePerson2Projekt({$row['id']}, 1)' /></td>\n";
		
		print "<td><input type='date' name='startdatum' value={$row['startdatum']}></td>\n";
		print "<td><input type='date' name='enddatum' value={$row['enddatum']}></td>\n";
		
		print "<td><select name='fk_priorität' 'size='1'>\n";
		$ddPriorität->listOptionsWithSelected($row['fk_priorität']);
		print "</select></td>\n";
		
		print "<td><select name='fk_komplexität' 'size='1'>\n";
		$ddKomplexität->listOptionsWithSelected($row['fk_komplexität']);
		print "</select></td>\n";
		
		print "<td><select name='fk_status' 'size='1'>\n";
		$ddStatus->listOptionsWithSelected($row['fk_status']);
		print "</select></td>\n";
		
		print "<td><input type='number' name='fortschritt' min='0' max='100' value={$row['fortschritt']}></td>\n";
		
		print "<td><input type='submit' name='update' value='update'></td>\n";
		print "</form></tr>\n";
	}
?>
		</table>
	</body>
</html>