<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="ppm.css">
		
		<script type="text/javascript">
			function addToPerson2Projekt() {
				listPersonenLength = personen.length;
				
				for (i = 0; i < listPersonenLength; i++) {
					if (personen.options[i].selected == true) {
						listPerson2ProjektLength = person2projekt.length;
						person2projekt.options[listPerson2ProjektLength] = new Option(personen.options[i].text, personen.options[i].value);
					}
				}
				
				for (i = (listPersonenLength - 1); i >=0; i--) {
					if (personen.options[i].selected == true) {
						personen.options[i] = null;
					}
				}
				
				sortOptions(person2projekt);
			}
			
			function removeFromPerson2Projekt() {
				listPerson2ProjektLength = person2projekt.length;
				
				for (i = 0; i < listPerson2ProjektLength; i++) {
					if (person2projekt.options[i].selected == true) {
						listPersonenLength = personen.length;
						personen.options[listPersonenLength] = new Option(person2projekt.options[i].text, person2projekt.options[i].value);
					}
				}
				
				for (i = (listPerson2ProjektLength - 1); i >=0; i--) {
					if (person2projekt.options[i].selected == true) {
						person2projekt.options[i] = null;
					}
				}
				
				sortOptions(personen);
			}
			
			function sortOptions(selElem) {
				var tmpAry = new Array();
				for (var i=0;i<selElem.options.length;i++) {
					tmpAry[i] = new Array();
					tmpAry[i][0] = selElem.options[i].text;
					tmpAry[i][1] = selElem.options[i].value;
				}
				tmpAry.sort();
				while (selElem.options.length > 0) {
					selElem.options[0] = null;
				}
				for (var i=0;i<tmpAry.length;i++) {
					var op = new Option(tmpAry[i][0], tmpAry[i][1]);
					selElem.options[i] = op;
				}
				return;
			}
		</script>
	</head>
	<body>
<?php
	$ini = parse_ini_file('ppm.ini');
	$db = new SQLite3("{$ini['dbFile']}");
	print "dbFile: {$ini['dbFile']}<br />\n";
	
	$projektID = $_POST['projektID'];
	$rolleID = $_POST['rolleID'];
	
	// DEBUG
	$postData = file_get_contents("php://input");
	var_dump($postData);
	
	print "projektID: {$projektID}\n";
	print "rolleID: {$rolleID}\n";
	
	$res = $db->query("SELECT name FROM t_list_rolle WHERE id = {$rolleID}");
	while ($row = $res->fetchArray()) {
		$rolle = $row['name'];
	}
?>
		<h2>Setze <?php print $rolle; ?> f√ºr Projekt ID <?php print $projektID; ?></h2>
		<form action="updatePerson2Projekt.html" method="POST" onsubmit="for (i = 0; i < person2projekt.length; i++) {person2projekt.options[i].selected = true;}">
			<input type="hidden" name="projektID" value="<?php print $projektID; ?>" />
			<input type="hidden" name="rolleID" value="<?php print $rolleID; ?>" />
			<table>
				<tr>
					<th>Personen</th>
					<th></th>
					<th><?php print $rolle; ?></th>
				</tr>
				<tr>
					<td>
						<select id="personen" name="personen" size=10 multiple>
<?php
	$res = $db->query("SELECT * FROM t_data_person WHERE id NOT IN (SELECT fk_person FROM t_rel_person2projekt WHERE fk_projekt = {$projektID} AND fk_rolle = {$rolleID})");
	while ($row = $res->fetchArray()) {
		print "<option value='{$row['id']}'>{$row['nachname']}</option>\n";
	}
?>			
						</select>
					</td>
					<td>
						<input type="button" onClick="addToPerson2Projekt()" value=">>" />
						<br /><br />
						<input type="button" onClick="removeFromPerson2Projekt()" value="<<" />
					</td>
					<td>
						<select id="person2projekt" name="person2projekt[]" size=10 multiple>
<?php
	$res = $db->query("SELECT * FROM t_data_person WHERE id IN (SELECT fk_person FROM t_rel_person2projekt WHERE fk_projekt = {$projektID} AND fk_rolle = {$rolleID})");
	while ($row = $res->fetchArray()) {
		print "<option value='{$row['id']}'>{$row['nachname']}</option>\n";
	}
?>							
						</select>
					</td>
				</tr>
			</table>
			<br />
			<input type="submit" name="save" value="Speichern" />
		</form>
	</body>
</html>